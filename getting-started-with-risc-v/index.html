<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
         "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta name="copyright" content="All content on muforth.nimblemachines.com is copyrighted. All rights are reserved." />
<meta name="keywords" content="riscv, risc-v, muforth, forth, support, openocd, hifive1, sifive, getting started" />
<meta name="robots" content="index,follow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/-/screen.css" type="text/css" />
<link rel="canonical" href="http://muforth.nimblemachines.com/getting-started-with-risc-v/" />
<title>Getting started with RISC-V &ndash; muforth</title>
</head>
<body>

<div id="header">
<h1>Getting started with RISC-V</h1>
<hr />
</div>

<div id="content">
<h2 id="introduction"><a href="#introduction">Introduction</a></h2>
<p>If you&rsquo;re here, it&rsquo;s because you want to try using <a href="/">muforth</a> to explore the world of RISC-V.</p>
<p>Currently this means that you have a <a href="https://www.crowdsupply.com/sifive/hifive1">HiFive1 board</a>; it is, at the moment, the only RISC-V hardware that muforth supports.</p>
<p>After getting a HiFive1, the next hurdle you have to jump is <a href="/getting-openocd-for-risc-v/">getting a copy of SiFive&rsquo;s port of <code>openocd</code></a>. (Read that page and then come back here.)</p>
<p>You do <em>not</em> need a GCC toolchain! Yay! Jump up and down and shout with glee! <code>openocd</code> is the <em>only</em> external tool that muforth needs in order to run code on a HiFive1.</p>
<h2 id="starting-out"><a href="#starting-out">Starting out</a></h2>
<p>If you&rsquo;ve never used muforth before, <a href="https://github.com/nimblemachines/muforth">get a copy</a>. <a href="https://github.com/nimblemachines/muforth/blob/master/BUILDING">BUILDING</a> has the very simple instructions for building muforth.</p>
<p>Once it is built, cd to <code>muforth/mu/</code>. You should <em>always</em> be in this directory when running muforth code.</p>
<p>Edit the file <code>target/RISC-V/start-openocd.sh</code> and change the <code>openocd</code> variable so it references <em>your</em> local copy of the SiFive <code>openocd</code>.</p>
<p>If you are on a Mac and running Mavericks or later, unload the Apple FTDI driver; otherwise it will interfere with JTAG:</p>
<pre>
  sudo kextunload /System/Library/Extensions/AppleUSBFTDI.kext/
</pre>
<p>Plug your HiFive1 into a USB port. Open a second terminal window, leaving the first one sitting in <code>muforth/mu</code>. cd to <code>muforth/mu</code> in this window as well. Then type the following command to start up <code>openocd</code>:</p>
<pre>
  target/RISC-V/start-openocd.sh
</pre>
<p>Back in the first <code>muforth/mu</code> window type this:</p>
<pre>
  ./muforth -f target/RISC-V/build.mu4
</pre>
<p>This will load the RISC-V meta-compiler and the RISC-V Forth kernel (which currently loads into RAM). To connect to the board via JTAG, type</p>
<pre>
  jtag
</pre>
<p>You should see a dump of four registers, all zero except for SP. You are now connected to the target board! To see some of the kernel code that was loaded into RAM, try this:</p>
<pre>
  @ram dis
</pre>
<p>This will start disassembling the beginning of the Forth kernel. All memory dumping and disassembly in muforth is <em>interactive</em>; pressing &lt;RET> or n will advance; pressing &lt;BS> or p will back up; q will quit, leaving the last-viewed address on the stack.</p>
<p>The word <code class="forth">@ram</code> is a constant; executing it pushes the address of the start of RAM (&ldquo;at-ram&rdquo;).</p>
<p>You can also look at built-in features. The Debug ROM is interesting. To see it type</p>
<pre>
  0800 dis
</pre>
<p>and keep pressing &lt;RET> to see further lines. Compare what you see here to what is documented in the <a href="https://dev.sifive.com/documentation/risc-v-external-debug-support-0-11/">debug spec version 0.11</a> <a href="https://static.dev.sifive.com/riscv-debug-spec-0.11nov12.pdf">(direct link)</a>.</p>
<p>To try actually executing some code, try this:</p>
<pre>
  10305 2040 +
</pre>
<p>This pushes two hex values onto the stack, copies this stack over to the target, executes the word <code class="forth">+</code> on the target, which adds them and pushes their sum, and then copies that back to the target. You should see the result in the stack dump.</p>
<p>To list the words in the target kernel, try this:</p>
<pre>
  target words
</pre>
<p>Something more interesting: Let&rsquo;s write a word to read the value of one of the chip&rsquo;s CSRs. This one &ndash; <code>misa</code> &ndash; tells us which base ISA &ndash; RV32 or RV64 &ndash; and which extensions the chip supports.</p>
<pre>
  code read-misa   misa w csrr   wpush j  ;c
  read-misa
</pre>
<p>The first line <em>defines</em> <code>read-misa</code> as a &ldquo;code&rdquo; word. This means that its definition is entirely in RISC-V assembler. It consists of just two instructions: one to read the CSR into the w register (an alias for ABI register t0), and one to jump to a routine that pushes w onto the stack and then executes NEXT. (On an ITC Forth all code words have to end by executing NEXT, directly or indirectly.)</p>
<p>The second lines executes our new word, and the result should show up on the stack. By reading the privileged ISA spec (see <a href="/risc-v-resources/">RISC-V resources</a>) we can peel this apart. But first, let&rsquo;s print its value in binary to make it easier to see:</p>
<pre>
  binary u. hex
</pre>
<p>This switches the input and output radix to binary, prints as an unsigned number the top of the stack (the contents of <code>misa</code>), then switches back to hex.</p>
<p>Unfortunately, <code class="forth">u.</code> doesn&rsquo;t print leading zeros, so it&rsquo;s hard to tell that the top two bits &ndash; which define the base ISA &ndash; are <code>01</code> &ndash; meaning RV32. The low order 26 bits each correspond to an ISA extension; the bit is set when that extension is present. I read the result as showing that IMAC are all present &ndash; exactly what we would expect from the FE310.</p>
<p>Next, let&rsquo;s try a simple &ldquo;colon&rdquo; word. A colon word is any word defined by <code class="forth">:</code> whose body consists of other Forth words. Most Forth code is colon words rather than code words.</p>
<pre>
  : bic   ( value mask - result)   invert and ;
</pre>
<p><code class="forth">bic</code> is the logical &ldquo;bit clear&rdquo; operation. It takes two parameters &ndash; shown in the &ldquo;stack comment&rdquo; (in parentheses) on the left of the dash &ndash; and produces one result &ndash; shown to the right of the dash. The first word, <code class="forth">invert</code>, does a ones complement of the mask; this is then <code>and</code>ed with the value. Any one bits in the mask clear the corresponding bit in the value. As usual, we see the result on the stack dump (which is always in hex, regardless of the setting of the input/output radix &ndash; an odd quirk of muforth).</p>
<p>Colon words always end with a <code class="forth">;</code>. When execution reaches this point, the word returns to its caller.</p>
<p>Let&rsquo;s try it.</p>
<pre>
  c0defeed ffff0000 bic
</pre>
<p>Hopefully the resulting value makes sense.</p>
<p>A couple of notes about numbers in muforth. Any number can be prefixed by a radix operator, which changes the radix <em>for that number only</em>. The operators, and their resulting radices, are:</p>
<pre>
  %  binary
  '  octal
  "  hexadecimal
  #  decimal
</pre>
<p>These can be handy if you are writing an assembler where most values are in octal but need to switch to another radix to enter a single value.</p>
<p>Following the (optional) radix operator can be an optional sign operator: the usual "-" character.</p>
<p>Another thing: numbers are generally printed with separators. This makes them much easier to parse. They can also be <em>input</em> with separators. Any of the following characters is a valid separator:</p>
<pre>
  . , : / _ -
</pre>
<p>Our stack has now accumulated some junk. You can get rid of it by typing</p>
<pre>
  .
</pre>
<p>over and over. Each execution of <code class="forth">.</code> prints &ndash; this time as a <em>signed</em> value &ndash; the top of the stack, thus removing one value. If there is a ton of junk on the stack, the word <code class="forth">sp-reset</code> clears the stack in one go.</p>
<p>I hope this whets your appetite for more! There is a lot more coming. See <a href="/risc-v-support/">RISC-V support</a> to see the current state of things.</p>
<h2 id="risc-v-and-sifive-documentation"><a href="#risc-v-and-sifive-documentation">RISC-V and SiFive documentation</a></h2>
<p>I&rsquo;ve compiled a page with lots of <a href="/risc-v-resources/">RISC-V resources</a>.</p>

</div>

<div id="footer">
<hr />
<a href="mailto:%77%65%62%68%61%6d%73%74%65%72%40%6e%69%6d%62%6c%65%6d%61%63%68%69%6e%65%73%2e%63%6f%6d?subject=%5bmuforth%5d%20Getting%20started%20with%20RISC-V">Send feedback</a> on this page (last edited 2017 April 07 14:36)<br />
Browse <a href="/all-pages/">all pages</a>, or return <a href="/">home</a><br />
<a href="https://twitter.com/share?url=http%3a%2f%2fmuforth.nimblemachines.com%2fgetting-started-with-risc-v%2f&text=Say%20something%20nice!">Tweet</a> this page, or follow <a href="https://twitter.com/muforth">@muforth</a>
</div>

</body>
</html>
