( This file is part of muFORTH: http://muforth.nimblemachines.com/

  Copyright 2002-2014 David Frech. All rights reserved, and all wrongs
  reversed. (See the file COPYRIGHT for details.)

( Code to test the ADC subsystem, by reading temperature and bandgap
  values.)

__meta

hex

ram

label adc-enable-bandgap
   SPMSC1 ) lda  01 # ora ( BGBE)  SPMSC1 ) sta  rts  ;c

label port-init
   0ff # lda  PTAPE ) sta  PTBPE ) sta  ( set pullups on all pins)
   rts  ;c

( Enter with ADC channel number in low 5 bits of A; exit with ADC value in
  HX.)

label adc-read-channel
   ADCSC1 ) sta  ( Set channel and start conversion)
   begin  ADCSC1 7 ( COCO) bset?  until  ( loop until conversion completes)
   ADCRH ) ldhx  ( read ADCRH into H, ADCRL into X)  rts  ;c

label adc-init
   port-init c  adc-enable-bandgap c
   -- %1001_0111 # ADCCFG ) mov  ( 12 bits; use asynch clock)
   %1001_1011 # ADCCFG ) mov  ( 10 bits; use asynch clock)
   rts  ;c

label read-temp
   adc-init c  #26 # lda  ( temp channel)  adc-read-channel j  ;c

label read-bandgap
   adc-init c  #27 # lda  ( bandgap channel)  adc-read-channel j  ;c
